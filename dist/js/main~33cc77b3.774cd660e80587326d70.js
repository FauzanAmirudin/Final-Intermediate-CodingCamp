"use strict";(self.webpackChunkstory_app=self.webpackChunkstory_app||[]).push([[409],{454:(e,t,r)=>{r.d(t,{i:()=>s});var o=r(551);class s{constructor(e,t={}){this.containerId=e,this.options={clickable:!1,showPopup:!0,center:[o.P.DEFAULT_COORDINATES.lat,o.P.DEFAULT_COORDINATES.lng],zoom:o.P.DEFAULT_COORDINATES.zoom,...t},this.map=null,this.markers=[],this.selectedLocation=null,this.selectionMarker=null}init(){this.createMap(),this.options.clickable&&this.enableLocationSelection()}createMap(){this.map=L.map(this.containerId).setView(this.options.center,this.options.zoom),L.tileLayer(o.P.MAP_TILE_URL,{attribution:o.P.MAP_ATTRIBUTION}).addTo(this.map)}enableLocationSelection(){this.map.on("click",(e=>{this.selectLocation(e.latlng)}))}selectLocation(e){const{lat:t,lng:r}=e;this.clearSelectionMarker(),this.selectionMarker=L.marker([t,r]).addTo(this.map),this.options.showPopup&&this.selectionMarker.bindPopup("Selected location").openPopup(),this.selectedLocation={lat:t,lng:r},this.options.onLocationSelect&&this.options.onLocationSelect(t,r)}addMarker(e,t,r="",o={}){const s=L.marker([e,t],o).addTo(this.map);return r&&s.bindPopup(r),this.markers.push(s),s}addMultipleMarkers(e){if(e.forEach((e=>{e.lat&&e.lng&&this.addMarker(e.lat,e.lng,e.popup||"",e.options||{})})),this.markers.length>0){const e=new L.featureGroup(this.markers);this.map.fitBounds(e.getBounds().pad(.1))}}clearSelectionMarker(){this.selectionMarker&&(this.map.removeLayer(this.selectionMarker),this.selectionMarker=null)}getSelectedLocation(){return this.selectedLocation}destroy(){this.map&&(this.map.remove(),this.map=null)}}},573:(e,t,r)=>{r.d(t,{A:()=>o});const o=new class{constructor(){this.dbName="StoryAppDB",this.dbVersion=1,this.storeName="stories",this.favoriteStoreName="favoriteStories",this.db=null}async init(){return new Promise(((e,t)=>{if(this.db)return e(this.db);console.log("Opening IndexedDB...");const r=indexedDB.open(this.dbName,this.dbVersion);r.onerror=e=>{console.error("IndexedDB error:",e.target.error),t("Error opening database")},r.onsuccess=t=>{this.db=t.target.result,console.log("IndexedDB opened successfully"),e(this.db)},r.onupgradeneeded=e=>{const t=e.target.result;if(console.log("Creating object stores..."),!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id"});e.createIndex("name","name",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}if(!t.objectStoreNames.contains(this.favoriteStoreName)){const e=t.createObjectStore(this.favoriteStoreName,{keyPath:"id"});e.createIndex("name","name",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1})}}}))}async addStory(e){try{return await this.init(),new Promise(((t,r)=>{const o=this.db.transaction([this.storeName],"readwrite"),s=o.objectStore(this.storeName);e.savedAt||(e.savedAt=(new Date).toISOString());const i=s.put(e);i.onsuccess=()=>{console.log("Story added to IndexedDB:",e.id),t(i.result)},i.onerror=e=>{console.error("Error adding story to IndexedDB:",e.target.error),r(e.target.error)},o.oncomplete=()=>{console.log("Transaction completed")}}))}catch(e){throw console.error("Failed to add story to IndexedDB:",e),e}}async getAllStories(){try{return await this.init(),new Promise(((e,t)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();r.onsuccess=()=>{console.log("Retrieved all stories from IndexedDB:",r.result.length),e(r.result)},r.onerror=e=>{console.error("Error getting stories from IndexedDB:",e.target.error),t(e.target.error)}}))}catch(e){throw console.error("Failed to get stories from IndexedDB:",e),e}}async getStory(e){try{return await this.init(),new Promise(((t,r)=>{const o=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);o.onsuccess=()=>{o.result?(console.log("Retrieved story from IndexedDB:",e),t(o.result)):(console.log("Story not found in IndexedDB:",e),t(null))},o.onerror=e=>{console.error("Error getting story from IndexedDB:",e.target.error),r(e.target.error)}}))}catch(e){throw console.error("Failed to get story from IndexedDB:",e),e}}async deleteStory(e){try{return await this.init(),new Promise(((t,r)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);o.onsuccess=()=>{console.log("Deleted story from IndexedDB:",e),t(!0)},o.onerror=e=>{console.error("Error deleting story from IndexedDB:",e.target.error),r(e.target.error)}}))}catch(e){throw console.error("Failed to delete story from IndexedDB:",e),e}}async addToFavorites(e){try{return await this.init(),new Promise(((t,r)=>{const o=this.db.transaction([this.favoriteStoreName],"readwrite").objectStore(this.favoriteStoreName);e.isFavorite=!0,e.favoritedAt=(new Date).toISOString();const s=o.put(e);s.onsuccess=()=>{console.log("Story added to favorites:",e.id),t(s.result)},s.onerror=e=>{console.error("Error adding story to favorites:",e.target.error),r(e.target.error)}}))}catch(e){throw console.error("Failed to add story to favorites:",e),e}}async removeFromFavorites(e){try{return await this.init(),new Promise(((t,r)=>{const o=this.db.transaction([this.favoriteStoreName],"readwrite").objectStore(this.favoriteStoreName).delete(e);o.onsuccess=()=>{console.log("Story removed from favorites:",e),t(!0)},o.onerror=e=>{console.error("Error removing story from favorites:",e.target.error),r(e.target.error)}}))}catch(e){throw console.error("Failed to remove story from favorites:",e),e}}async getAllFavorites(){try{return await this.init(),new Promise(((e,t)=>{const r=this.db.transaction([this.favoriteStoreName],"readonly").objectStore(this.favoriteStoreName).getAll();r.onsuccess=()=>{console.log("Retrieved all favorite stories:",r.result.length),e(r.result)},r.onerror=e=>{console.error("Error getting favorite stories:",e.target.error),t(e.target.error)}}))}catch(e){throw console.error("Failed to get favorite stories:",e),e}}async isFavorite(e){try{return await this.init(),new Promise(((t,r)=>{const o=this.db.transaction([this.favoriteStoreName],"readonly").objectStore(this.favoriteStoreName).get(e);o.onsuccess=()=>{t(!!o.result)},o.onerror=e=>{console.error("Error checking if story is favorite:",e.target.error),r(e.target.error)}}))}catch(e){throw console.error("Failed to check if story is favorite:",e),e}}async clearAllData(){try{return await this.init(),Promise.all([new Promise(((e,t)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();r.onsuccess=()=>{console.log("Cleared all stories from IndexedDB"),e(!0)},r.onerror=e=>{console.error("Error clearing stories:",e.target.error),t(e.target.error)}})),new Promise(((e,t)=>{const r=this.db.transaction([this.favoriteStoreName],"readwrite").objectStore(this.favoriteStoreName).clear();r.onsuccess=()=>{console.log("Cleared all favorite stories from IndexedDB"),e(!0)},r.onerror=e=>{console.error("Error clearing favorite stories:",e.target.error),t(e.target.error)}}))])}catch(e){throw console.error("Failed to clear all data from IndexedDB:",e),e}}}},676:(e,t,r)=>{r.d(t,{U:()=>n});var o=r(551),s=r(763),i=r(170);class n{static getAuthHeaders(){const e=s.R.getToken();return e?{Authorization:`Bearer ${e}`,Accept:"application/json"}:{Accept:"application/json"}}static async getAllStories(e=1,t=20,r=1){try{const s=new URLSearchParams({page:e.toString(),size:t.toString(),location:r.toString()}),n=`${o.P.API_BASE_URL}/stories?${s}`;console.log("Fetching stories from:",n);const a=await fetch(n,{method:"GET",headers:this.getAuthHeaders()});if(!a.ok)throw new i.h("Failed to fetch stories",a.status);return await a.json()}catch(e){if(console.error("Error in getAllStories:",e),i.h.isNetworkError(e))throw new i.h("Failed to connect to the server",null,!0);if(e instanceof i.h)throw e;throw new i.h(e.message)}}static async getStoryDetail(e){try{console.log("Fetching story detail for ID:",e);const t=await fetch(`${o.P.API_BASE_URL}/stories/${e}`,{method:"GET",headers:this.getAuthHeaders()});if(console.log("Story detail response status:",t.status),!t.ok){const e=await t.text();if(console.error("Error response:",e),401===t.status)throw new Error("Authentication failed. Please login again.");throw new Error(`HTTP ${t.status}: ${e}`)}const r=await t.json();return console.log("Story detail received:",r),r}catch(e){if(console.error("Error in getStoryDetail:",e),"TypeError"===e.name&&e.message.includes("fetch"))throw new Error("Network error: Please check your internet connection");throw e}}static async addStory(e){try{console.log("Adding story..."),console.log("FormData contents:");for(let[t,r]of e.entries())"photo"===t?console.log(t,"- File size:",r.size,"bytes"):console.log(t,":",r);const t=await fetch(`${o.P.API_BASE_URL}/stories`,{method:"POST",headers:{Authorization:`Bearer ${s.R.getToken()}`},body:e});if(!t.ok){const e=await t.json().catch((()=>({})));throw new i.h(e.message||"Failed to add story",t.status)}const r=await t.json();return console.log("Story added successfully:",r),r}catch(e){if(console.error("Error in addStory:",e),i.h.isNetworkError(e))throw new i.h("Failed to connect to the server",null,!0);if(e instanceof i.h)throw e;throw new i.h(e.message)}}static async register(e){try{console.log("Registering user:",e.email);const t=await fetch(`${o.P.API_BASE_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(console.log("Register response:",r),!t.ok)throw new i.h(r.message||"Registration failed",t.status);return r}catch(e){if(console.error("Error in register:",e),i.h.isNetworkError(e))throw new i.h("Failed to connect to the server",null,!0);if(e instanceof i.h)throw e;throw new i.h(e.message)}}static async login(e){try{console.log("Logging in user:",e.email);const t=await fetch(`${o.P.API_BASE_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(console.log("Login response:",r),!t.ok)throw new i.h(r.message||"Login failed",t.status);return!1===r.error&&r.loginResult&&r.loginResult.token&&(s.R.setToken(r.loginResult.token),s.R.setUserInfo({userId:r.loginResult.userId,name:r.loginResult.name,email:e.email})),r}catch(e){if(console.error("Error in login:",e),i.h.isNetworkError(e))throw new i.h("Failed to connect to the server",null,!0);if(e instanceof i.h)throw e;throw new i.h(e.message)}}}},717:(e,t,r)=>{r.d(t,{n:()=>o});class o{constructor(e){this.container=document.getElementById(e),this.stream=null,this.capturedBlob=null,this.init()}init(){this.createCameraElements(),this.bindEvents()}createCameraElements(){this.container.innerHTML='\n            <div class="camera-container">\n                <video id="camera-video" class="camera-video" autoplay style="display: none;"></video>\n                <canvas id="camera-canvas" style="display: none;"></canvas>\n                <img id="camera-preview" class="camera-preview" style="display: none;" alt="Captured photo preview">\n                <div class="camera-controls">\n                    <button type="button" id="start-camera" class="btn btn-primary">Start Camera</button>\n                    <button type="button" id="capture-photo" class="btn btn-success" style="display: none;">Capture Photo</button>\n                    <button type="button" id="retake-photo" class="btn btn-secondary" style="display: none;">Retake</button>\n                </div>\n            </div>\n        ',this.video=document.getElementById("camera-video"),this.canvas=document.getElementById("camera-canvas"),this.preview=document.getElementById("camera-preview"),this.startBtn=document.getElementById("start-camera"),this.captureBtn=document.getElementById("capture-photo"),this.retakeBtn=document.getElementById("retake-photo")}bindEvents(){this.startBtn.addEventListener("click",(()=>this.startCamera())),this.captureBtn.addEventListener("click",(()=>this.capturePhoto())),this.retakeBtn.addEventListener("click",(()=>this.retakePhoto()))}async startCamera(){try{this.stream=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}}}),this.video.srcObject=this.stream,this.showElement(this.video),this.hideElement(this.startBtn),this.showElement(this.captureBtn)}catch(e){console.error("Error accessing camera:",e),this.showError("Error accessing camera: "+e.message)}}capturePhoto(){const e=this.canvas.getContext("2d");this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,e.drawImage(this.video,0,0),this.canvas.toBlob((e=>{this.capturedBlob=e;const t=URL.createObjectURL(e);this.preview.src=t,this.showElement(this.preview),this.hideElement(this.video),this.hideElement(this.captureBtn),this.showElement(this.retakeBtn),this.stopCamera()}),"image/jpeg",.8)}retakePhoto(){this.hideElement(this.preview),this.hideElement(this.retakeBtn),this.showElement(this.startBtn),this.capturedBlob=null,this.preview.src&&URL.revokeObjectURL(this.preview.src)}stopCamera(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=null)}getCapturedPhoto(){return this.capturedBlob}showElement(e){e.style.display="block"}hideElement(e){e.style.display="none"}showError(e){const t=document.createElement("div");t.className="error",t.textContent=e,this.container.appendChild(t),setTimeout((()=>{t.remove()}),5e3)}destroy(){this.stopCamera(),this.preview&&this.preview.src&&URL.revokeObjectURL(this.preview.src)}}},771:(e,t,r)=>{var o=r(836),s=r(361),i=r(871),n=r(789),a=r(555),c=r(763),l=r(573),d=r(459),h=r(477),u=r(867);class m{constructor(){this.router=new o.I,this.currentView=null,this.deferredPrompt=null,this.init(),this.setupSkipToContent(),this.setupInstallPrompt()}async init(){try{await l.A.init(),console.log("IndexedDB initialized successfully")}catch(e){console.error("Failed to initialize IndexedDB:",e)}this.registerServiceWorker(),this.setupRoutes(),this.setupNavigation(),this.setupAuthCheck(),window.addEventListener("unhandledrejection",(e=>{console.error("Unhandled promise rejection:",e.reason)})),this.router.handleRoute()}setupInstallPrompt(){window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),this.deferredPrompt=e,setTimeout((()=>{this.showInstallButton()}),3e3)})),window.addEventListener("appinstalled",(()=>{console.log("PWA was installed"),this.hideInstallButton()}))}showInstallButton(){if(!this.deferredPrompt)return;if("/home"!==this.router.getCurrentRoute())return;if(document.getElementById("pwa-install-button"))return;const e=document.createElement("div");e.className="install-banner",e.id="pwa-install-banner",e.innerHTML='\n      <div class="install-content">\n        <p>Install Story App for a better experience!</p>\n        <div class="install-actions">\n          <button id="pwa-install-button" class="btn btn-primary">Install</button>\n          <button id="pwa-dismiss-button" class="btn btn-secondary">Not Now</button>\n        </div>\n      </div>\n    ';const t=document.getElementById("main-content");t&&(t.prepend(e),document.getElementById("pwa-install-button").addEventListener("click",this.installPWA.bind(this)),document.getElementById("pwa-dismiss-button").addEventListener("click",this.hideInstallButton.bind(this)))}hideInstallButton(){const e=document.getElementById("pwa-install-banner");e&&e.remove()}async installPWA(){if(!this.deferredPrompt)return;this.deferredPrompt.prompt();const e=await this.deferredPrompt.userChoice;console.log("User installation choice:",e.outcome),this.deferredPrompt=null,this.hideInstallButton()}registerServiceWorker(){window.addEventListener("load",(()=>{"serviceWorker"in navigator?navigator.serviceWorker.register("/service-worker.js").then((e=>{console.log("Service Worker registered with scope:",e.scope),c.R.isAuthenticated()&&this.subscribeToPushNotifications()}),(e=>{console.error("Service Worker registration failed:",e)})):console.warn("Service workers are not supported in this browser")}))}async subscribeToPushNotifications(){try{const e=await d.A.checkPushSupport();e.supported&&"granted"===e.permission?(await d.A.subscribeToPushNotifications(),console.log("Successfully subscribed to push notifications")):e.supported&&"denied"!==e.permission&&"granted"===await Notification.requestPermission()&&(await d.A.subscribeToPushNotifications(),console.log("Successfully subscribed to push notifications after permission grant"))}catch(e){console.error("Failed to subscribe to push notifications:",e)}}setupRoutes(){this.router.addRoute("/home",(()=>this.renderHome())),this.router.addRoute("/add",(()=>this.renderAddStory())),this.router.addRoute("/login",(()=>this.renderLogin())),this.router.addRoute("/register",(()=>this.renderRegister())),this.router.addRoute("/favorites",(()=>this.renderFavorites())),this.router.addRoute("/saved",(()=>this.renderSavedStories()))}setupNavigation(){window.addEventListener("hashchange",(()=>{this.updateActiveNavLink(),this.updateNavbar()})),this.updateActiveNavLink(),this.updateNavbar()}setupAuthCheck(){window.addEventListener("hashchange",(()=>{const e=this.router.getCurrentRoute();["/add","/favorites","/saved"].includes(e)&&!c.R.isAuthenticated()&&this.router.navigate("/login")}))}setupSkipToContent(){const e=document.getElementById("skip-link"),t=document.getElementById("main-content");e&&t&&e.addEventListener("click",(e=>{e.preventDefault(),t.focus()}))}updateNavbar(){const e=c.R.isAuthenticated(),t=document.querySelector(".nav-menu"),r=c.R.getUserInfo();t.innerHTML=e&&r?`\n        <li><a href="#/home" class="nav-link">Home</a></li>\n        <li><a href="#/add" class="nav-link">Add Story</a></li>\n        <li><a href="#/favorites" class="nav-link">Favorites</a></li>\n        <li><a href="#/saved" class="nav-link">Saved Stories</a></li>\n        <li class="user-menu">\n          <span class="user-name">Hello, ${r.name}</span>\n          <button class="btn btn-secondary btn-small" onclick="window.app.logout()">Logout</button>\n        </li>\n      `:'\n        <li><a href="#/home" class="nav-link">Home</a></li>\n        <li><a href="#/login" class="nav-link">Login</a></li>\n        <li><a href="#/register" class="nav-link">Register</a></li>\n      '}updateActiveNavLink(){const e=this.router.getCurrentRoute();document.querySelectorAll(".nav-link").forEach((t=>{t.getAttribute("href")===`#${e}`?(t.classList.add("active"),t.setAttribute("aria-current","page")):(t.classList.remove("active"),t.removeAttribute("aria-current"))}))}renderHome(){this.destroyCurrentView(),this.currentView=new s.v,this.currentView.render(),this.deferredPrompt&&this.showInstallButton()}renderAddStory(){c.R.isAuthenticated()?(this.destroyCurrentView(),this.currentView=new i.w(this.router),this.currentView.render()):this.router.navigate("/login")}renderLogin(){c.R.isAuthenticated()?this.router.navigate("/home"):(this.destroyCurrentView(),this.currentView=new n.r(this.router),this.currentView.render())}renderRegister(){c.R.isAuthenticated()?this.router.navigate("/home"):(this.destroyCurrentView(),this.currentView=new a.Z(this.router),this.currentView.render())}renderFavorites(){c.R.isAuthenticated()?(this.destroyCurrentView(),this.currentView=new h.d,this.currentView.render()):this.router.navigate("/login")}renderSavedStories(){c.R.isAuthenticated()?(this.destroyCurrentView(),this.currentView=new u.G,this.currentView.render()):this.router.navigate("/login")}async logout(){try{await d.A.unsubscribeFromPushNotifications()}catch(e){console.error("Error unsubscribing from push notifications:",e)}c.R.logout(),this.updateNavbar(),this.router.navigate("/login")}destroyCurrentView(){this.currentView&&"function"==typeof this.currentView.destroy&&(this.currentView.destroy(),this.currentView=null)}}document.addEventListener("DOMContentLoaded",(()=>{console.log("App initializing..."),window.app=new m})),window.addEventListener("beforeunload",(()=>{document.querySelectorAll("video").forEach((e=>{e.srcObject&&e.srcObject.getTracks().forEach((e=>e.stop()))}))}))}}]);