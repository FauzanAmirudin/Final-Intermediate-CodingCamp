"use strict";(self.webpackChunkstory_app=self.webpackChunkstory_app||[]).push([[287],{170:(e,t,o)=>{o.d(t,{h:()=>n});class n extends Error{constructor(e,t=null,o=!1){super(e),this.name="ApiError",this.status=t,this.isNetworkError=o}static handle(e){if(e instanceof n)switch(e.status){case 401:return"Session expired. Please login again.";case 403:return"You don't have permission to perform this action.";case 404:return"The requested resource was not found.";case 413:return"The file you're trying to upload is too large.";case 429:return"Too many requests. Please try again later.";case 500:return"Server error. Please try again later.";default:return e.isNetworkError?"Network error: Please check your internet connection.":e.message||"An unexpected error occurred."}return e.message||"An unexpected error occurred."}static isNetworkError(e){return"TypeError"===e.name&&(e.message.includes("fetch")||e.message.includes("network")||e.message.includes("Failed to fetch"))}}},361:(e,t,o)=>{o.d(t,{v:()=>d});var n=o(454),r=o(676),i=(o(170),o(573));class s{constructor(e){this.view=e,this.stories=[]}async loadStories(){try{const e=await r.U.getAllStories();if(!1!==e.error||!e.listStory)throw new Error("Failed to load stories from API");this.stories=e.listStory,await this.saveStoriesToIndexedDB(this.stories),this.view.hideLoading(),this.view.renderStories(this.stories),this.stories.filter((e=>e.lat&&e.lon)).length>0&&this.view.renderStoriesMap(this.stories)}catch(e){console.error("Error loading stories from API:",e);try{console.log("Attempting to load stories from IndexedDB...");const e=await i.A.getAllStories();e&&e.length>0?(console.log("Loaded stories from IndexedDB:",e.length),this.stories=e,this.view.hideLoading(),this.view.renderStories(this.stories),this.view.showOfflineNotification(),this.stories.filter((e=>e.lat&&e.lon)).length>0&&this.view.renderStoriesMap(this.stories)):(this.view.hideLoading(),this.view.showNoStories())}catch(e){console.error("Error loading stories from IndexedDB:",e),this.view.hideLoading(),this.view.showError("Failed to load stories. Please check your internet connection and try again.")}}}async saveStoriesToIndexedDB(e){try{await i.A.init();for(const t of e)t.savedAt=(new Date).toISOString(),await i.A.isFavorite(t.id)&&(t.isFavorite=!0),await i.A.addStory(t);console.log(`Successfully saved ${e.length} stories to IndexedDB`)}catch(e){console.error("Error saving stories to IndexedDB:",e)}}async addStoryToFavorites(e){try{const t=this.stories.find((t=>t.id===e));if(!t)throw new Error("Story not found");return await i.A.addToFavorites(t),!0}catch(e){return console.error("Error adding story to favorites:",e),!1}}async removeStoryFromFavorites(e){try{return await i.A.removeFromFavorites(e),!0}catch(e){return console.error("Error removing story from favorites:",e),!1}}}var a=o(763);class d{constructor(){this.presenter=new s(this)}async render(){const e=document.getElementById("page-container");if(!e)return void console.error("Page container not found");const t=a.R.isAuthenticated();e.innerHTML=`\n      <div class="page">\n        <section class="hero">\n          <h1>Welcome to Story App</h1>\n          <p>Discover amazing stories from around the world</p>\n        </section>\n        <div id="offline-notification" class="offline-notification" style="display: none;">\n          <p>You are currently offline. Showing saved stories.</p>\n        </div>\n        <section class="stories-section">\n          <div class="stories-header">\n            <h2>Latest Stories</h2>\n            ${t?'<a href="#/add" class="btn btn-primary">Add New Story</a>':'<a href="#/login" class="btn btn-primary">Login to Add Story</a>'}\n          </div>\n          <div class="loading" id="loading-indicator">\n            <div class="loading-spinner"></div>\n            <p>Loading Stories...</p>\n          </div>\n          <div id="stories-container"></div>\n        </section>\n      </div>\n    `,document.getElementById("stories-container")?await this.presenter.loadStories():console.error("Stories container not found")}renderStories(e){const t=document.getElementById("stories-container");e&&0!==e.length?(t.innerHTML=`\n      <div class="story-list">\n        ${e.map((e=>this.createStoryCard(e))).join("")}\n      </div>\n    `,this.addFavoriteButtonListeners()):t.innerHTML='\n        <div class="no-stories">\n          <h3>No stories available yet</h3>\n          <p>Be the first to share your story!</p>\n          <a href="#/add" class="btn btn-primary">Add Your Story</a>\n        </div>\n      '}createStoryCard(e){if(!e)return"";const t=e.id||"",o=e.name||"Anonymous",n=e.description||"No description available",r=e.photoUrl||"",i=e.isFavorite||!1;let s="Unknown date";if(e.createdAt)try{s=new Date(e.createdAt).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(t){console.warn("Invalid date format:",e.createdAt),s=e.createdAt}return`\n      <article class="story-card" data-story-id="${t}">\n        <img src="${r}" \n             alt="Story photo by ${this.escapeHtml(o)}" \n             class="story-image" \n             loading="lazy"\n             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'">\n        <div class="story-content">\n          <h3 class="story-title">${this.escapeHtml(o)}</h3>\n          <p class="story-description">${this.escapeHtml(n.length>150?n.substring(0,150)+"...":n)}</p>\n          <div class="story-meta">\n            <p class="story-author">By: ${this.escapeHtml(o)}</p>\n            <p class="story-date">üìÖ ${s}</p>\n            ${e.lat&&e.lon?`<p class="story-location">üìç ${parseFloat(e.lat).toFixed(4)}, ${parseFloat(e.lon).toFixed(4)}</p>`:""}\n          </div>\n          <div class="story-actions">\n            ${a.R.isAuthenticated()?`\n              <button class="btn ${i?"btn-danger remove-favorite-btn":"btn-secondary add-favorite-btn"}" \n                      data-story-id="${t}">\n                ${i?"Remove from Favorites":"Add to Favorites"}\n              </button>\n            `:""}\n          </div>\n        </div>\n      </article>\n    `}addFavoriteButtonListeners(){document.querySelectorAll(".add-favorite-btn").forEach((e=>{e.addEventListener("click",(async t=>{const o=t.target.dataset.storyId;try{await this.presenter.addStoryToFavorites(o)&&(e.classList.remove("btn-secondary"),e.classList.add("btn-danger"),e.classList.remove("add-favorite-btn"),e.classList.add("remove-favorite-btn"),e.textContent="Remove from Favorites",e.removeEventListener("click",(()=>{})),e.addEventListener("click",this.handleRemoveFavorite.bind(this)),this.showNotification("Story added to favorites"))}catch(e){console.error("Error adding to favorites:",e),this.showNotification("Failed to add to favorites","error")}}))})),document.querySelectorAll(".remove-favorite-btn").forEach((e=>{e.addEventListener("click",this.handleRemoveFavorite.bind(this))}))}async handleRemoveFavorite(e){const t=e.target.dataset.storyId;try{if(await this.presenter.removeStoryFromFavorites(t)){const t=e.target;t.classList.remove("btn-danger"),t.classList.add("btn-secondary"),t.classList.remove("remove-favorite-btn"),t.classList.add("add-favorite-btn"),t.textContent="Add to Favorites",t.removeEventListener("click",this.handleRemoveFavorite),t.addEventListener("click",(async e=>{const t=e.target.dataset.storyId;await this.presenter.addStoryToFavorites(t)})),this.showNotification("Story removed from favorites")}}catch(e){console.error("Error removing from favorites:",e),this.showNotification("Failed to remove from favorites","error")}}showNotification(e,t="success"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.classList.add("fade-out"),setTimeout((()=>{document.body.removeChild(o)}),500)}),3e3)}showOfflineNotification(){const e=document.getElementById("offline-notification");e&&(e.style.display="block")}renderStoriesMap(e){const t=document.getElementById("stories-container");if(document.getElementById("stories-map"))return;const o=document.createElement("section");o.className="map-section",o.innerHTML='\n      <h2>Stories Around the World</h2>\n      <div id="stories-map" class="map-container"></div>\n    ',t.appendChild(o),setTimeout((()=>{try{const t=new n.i("stories-map",{clickable:!1,showPopup:!0,zoom:5});t.init();const o=e.filter((e=>e&&null!==e.lat&&void 0!==e.lat&&null!==e.lon&&void 0!==e.lon&&!isNaN(parseFloat(e.lat))&&!isNaN(parseFloat(e.lon))&&0!==parseFloat(e.lat)&&0!==parseFloat(e.lon))).map((e=>({lat:parseFloat(e.lat),lng:parseFloat(e.lon),popup:`\n              <div class="map-popup">\n                <h4>${this.escapeHtml(e.name||"Anonymous")}</h4>\n                <p>${this.escapeHtml((e.description||"").substring(0,100))}${(e.description||"").length>100?"...":""}</p>\n                <small>üìÖ ${e.createdAt?new Date(e.createdAt).toLocaleDateString("id-ID"):"Unknown date"}</small>\n                <br>\n                <small>üìç ${parseFloat(e.lat).toFixed(4)}, ${parseFloat(e.lon).toFixed(4)}</small>\n              </div>\n            `})));console.log("Story locations for map:",o),o.length>0?t.addMultipleMarkers(o):(console.warn("No valid story locations found for map"),document.getElementById("stories-map").innerHTML='\n            <div class="map-no-data">\n              <p>No location data available for stories</p>\n              <small>Stories need to have valid coordinates to appear on the map</small>\n            </div>\n          ')}catch(e){console.error("Error initializing map:",e);const t=document.querySelector(".map-section");t&&(t.innerHTML=`\n            <h2>Stories Around the World</h2>\n            <div class="map-error">\n              <p>Unable to load map</p>\n              <small>Error: ${e.message}</small>\n            </div>\n          `)}}),100)}hideLoading(){const e=document.getElementById("loading-indicator");e&&(e.style.display="none")}showNoStories(){const e=document.getElementById("stories-container"),t=a.R.isAuthenticated();e.innerHTML=`\n      <div class="no-stories">\n        <h3>No stories available yet</h3>\n        <p>Be the first to share your story!</p>\n        ${t?'<a href="#/add" class="btn btn-primary">Add Your Story</a>':'<a href="#/login" class="btn btn-primary">Login to Add Story</a>'}\n      </div>\n    `}showError(e,t="general"){const o=document.getElementById("stories-container");if(!o)return void console.error("Stories container not found when showing error");o.innerHTML=`\n      <div class="error-container error-${t}">\n        <div class="error-icon">‚ö†Ô∏è</div>\n        <h3>Error</h3>\n        <p>${e}</p>\n        <button id="retry-button" class="btn btn-primary">Try Again</button>\n      </div>\n    `;const n=document.getElementById("retry-button");n&&n.addEventListener("click",(()=>{this.render()}))}escapeHtml(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}destroy(){document.querySelectorAll(".add-favorite-btn").forEach((e=>{e.removeEventListener("click",(()=>{}))})),document.querySelectorAll(".remove-favorite-btn").forEach((e=>{e.removeEventListener("click",this.handleRemoveFavorite)}))}}},459:(e,t,o)=>{o.d(t,{A:()=>i});var n=o(551),r=o(763);const i=new class{constructor(){this.publicVapidKey="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"}urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),o=window.atob(t),n=new Uint8Array(o.length);for(let e=0;e<o.length;++e)n[e]=o.charCodeAt(e);return n}async registerServiceWorker(){if(!("serviceWorker"in navigator))throw new Error("Service Worker not supported in this browser");try{const e=await navigator.serviceWorker.register("/service-worker.js");return console.log("Service Worker registered successfully:",e),e}catch(e){throw console.error("Service Worker registration failed:",e),e}}async subscribeToPushNotifications(){try{const e=await navigator.serviceWorker.ready;if(!("PushManager"in window))throw new Error("Push notifications not supported in this browser");if("granted"!==await Notification.requestPermission())throw new Error("Notification permission denied");let t=await e.pushManager.getSubscription();return t?console.log("Using existing push subscription:",t):(t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(this.publicVapidKey)}),console.log("Created new push subscription:",t)),await this.sendSubscriptionToServer(t),t}catch(e){throw console.error("Error subscribing to push notifications:",e),e}}async unsubscribeFromPushNotifications(){try{const e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t){await this.removeSubscriptionFromServer(t);const e=await t.unsubscribe();return console.log("Unsubscribed from push notifications:",e),e}return!1}catch(e){throw console.error("Error unsubscribing from push notifications:",e),e}}async sendSubscriptionToServer(e){try{if(!r.R.isAuthenticated())return console.warn("User not authenticated, cannot send subscription to server"),!1;const t=r.R.getToken(),o=e.getKey("p256dh"),i=e.getKey("auth"),s=btoa(String.fromCharCode.apply(null,new Uint8Array(o))),a=btoa(String.fromCharCode.apply(null,new Uint8Array(i)));console.log("Sending subscription to server with data:",{endpoint:e.endpoint,keys:{p256dh:s,auth:a}});const d=await fetch(`${n.P.API_BASE_URL}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({endpoint:e.endpoint,keys:{p256dh:s,auth:a}})});if(!d.ok){const e=await d.json();throw console.error("Server response error:",e),new Error(e.message||"Failed to send subscription to server")}const l=await d.json();return console.log("Subscription sent to server successfully:",l),l}catch(e){throw console.error("Error sending subscription to server:",e),e}}async removeSubscriptionFromServer(e){try{if(!r.R.isAuthenticated())return console.warn("User not authenticated, cannot remove subscription from server"),!1;const t=r.R.getToken(),o=await fetch(`${n.P.API_BASE_URL}/notifications/subscribe`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({endpoint:e.endpoint})});if(!o.ok){const e=await o.json();throw new Error(e.message||"Failed to remove subscription from server")}const i=await o.json();return console.log("Subscription removed from server successfully:",i),i}catch(e){throw console.error("Error removing subscription from server:",e),e}}async checkPushSupport(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return{supported:!1,message:"Push notifications are not supported in your browser"};const e=Notification.permission;return"granted"===e?{supported:!0,message:"Push notifications are supported and enabled",permission:e}:"denied"===e?{supported:!1,message:"Notification permission denied",permission:e}:{supported:!0,message:"Push notifications are supported but not enabled yet",permission:e}}}},477:(e,t,o)=>{o.d(t,{d:()=>r});var n=o(573);class r{constructor(){this.container=document.getElementById("page-container"),this.favoriteStories=[]}async render(){this.container.innerHTML='\n      <section class="favorites-section">\n        <h2>Your Favorite Stories</h2>\n        <p>Stories you\'ve marked as favorites.</p>\n        <div class="favorites-container" id="favorites-container">\n          <div class="loading-indicator">Loading favorites...</div>\n        </div>\n      </section>\n    ',await this.loadFavorites()}async loadFavorites(){try{const e=document.getElementById("favorites-container");if(this.favoriteStories=await n.A.getAllFavorites(),0===this.favoriteStories.length)return void(e.innerHTML='\n          <div class="empty-state">\n            <p>You haven\'t added any stories to your favorites yet.</p>\n            <p>Browse stories and click the heart icon to add them to your favorites.</p>\n          </div>\n        ');this.favoriteStories.sort(((e,t)=>new Date(t.favoritedAt)-new Date(e.favoritedAt))),e.innerHTML=this.favoriteStories.map((e=>`\n          <div class="story-card" data-id="${e.id}">\n            <div class="story-image">\n              <img src="${e.photoUrl}" alt="${e.name}'s story" loading="lazy">\n            </div>\n            <div class="story-content">\n              <h3 class="story-title">${e.name}</h3>\n              <p class="story-description">${e.description}</p>\n              <div class="story-meta">\n                <span class="story-date">Added to favorites: ${this.formatDate(e.favoritedAt)}</span>\n              </div>\n              <div class="story-actions">\n                <button class="btn btn-danger remove-favorite-btn" data-id="${e.id}">\n                  Remove from Favorites\n                </button>\n              </div>\n            </div>\n          </div>\n        `)).join(""),this.addRemoveButtonListeners()}catch(e){console.error("Error loading favorites:",e),document.getElementById("favorites-container").innerHTML=`\n        <div class="error-state">\n          <p>Failed to load your favorite stories.</p>\n          <p>Error: ${e.message}</p>\n        </div>\n      `}}addRemoveButtonListeners(){document.querySelectorAll(".remove-favorite-btn").forEach((e=>{e.addEventListener("click",(async e=>{const t=e.target.dataset.id;try{await n.A.removeFromFavorites(t),await this.loadFavorites(),this.showNotification("Story removed from favorites")}catch(e){console.error("Error removing from favorites:",e),this.showNotification("Failed to remove from favorites","error")}}))}))}showNotification(e,t="success"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.classList.add("fade-out"),setTimeout((()=>{document.body.removeChild(o)}),500)}),3e3)}formatDate(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}destroy(){document.querySelectorAll(".remove-favorite-btn").forEach((e=>{e.removeEventListener("click",(()=>{}))}))}}},551:(e,t,o)=>{o.d(t,{P:()=>n});const n={API_BASE_URL:"https://story-api.dicoding.dev/v1",MAP_ATTRIBUTION:"¬© OpenStreetMap contributors",MAP_TILE_URL:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",DEFAULT_COORDINATES:{lat:-6.2,lng:106.816666,zoom:10}}},555:(e,t,o)=>{o.d(t,{Z:()=>r});var n=o(676);class r{constructor(e){this.router=e}render(){document.getElementById("page-container").innerHTML='\n            <div class="page">\n                <section class="auth-section">\n                    <div class="auth-container">\n                        <h1>Register to Story App</h1>\n                        <form id="register-form" class="form-container">\n                            <div class="form-group">\n                                <label for="register-name" class="form-label">Full Name *</label>\n                                <input type="text" \n                                       id="register-name" \n                                       name="name" \n                                       class="form-input" \n                                       required\n                                       placeholder="Enter your full name">\n                                <div class="form-error" id="name-error"></div>\n                            </div>\n\n                            <div class="form-group">\n                                <label for="register-email" class="form-label">Email *</label>\n                                <input type="email" \n                                       id="register-email" \n                                       name="email" \n                                       class="form-input" \n                                       required\n                                       placeholder="Enter your email">\n                                <div class="form-error" id="email-error"></div>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="register-password" class="form-label">Password *</label>\n                                <input type="password" \n                                       id="register-password" \n                                       name="password" \n                                       class="form-input" \n                                       required\n                                       minlength="8"\n                                       placeholder="Minimum 8 characters">\n                                <small class="form-help">Password must be at least 8 characters</small>\n                                <div class="form-error" id="password-error"></div>\n                            </div>\n                            \n                            <div class="form-actions">\n                                <button type="submit" class="btn btn-primary" id="register-btn">\n                                    <span class="btn-text">Register</span>\n                                    <span class="btn-loading" style="display: none;">\n                                        <span class="loading-spinner small"></span>\n                                        Creating account...\n                                    </span>\n                                </button>\n                            </div>\n                            \n                            <div id="register-message"></div>\n                        </form>\n                        \n                        <div class="auth-switch">\n                            <p>Already have an account? <a href="#/login" class="link">Login here</a></p>\n                        </div>\n                    </div>\n                </section>\n            </div>\n        ',this.initializeForm()}initializeForm(){document.getElementById("register-form").addEventListener("submit",(e=>this.handleRegister(e)))}async handleRegister(e){e.preventDefault();const t=document.getElementById("register-name").value.trim(),o=document.getElementById("register-email").value.trim(),r=document.getElementById("register-password").value;if(!t||!o||!r)return void this.showMessage("Please fill in all fields","error");if(r.length<8)return void this.showMessage("Password must be at least 8 characters","error");const i=document.getElementById("register-btn"),s=i.querySelector(".btn-text"),a=i.querySelector(".btn-loading");i.disabled=!0,s.style.display="none",a.style.display="inline-flex";try{const e=await n.U.register({name:t,email:o,password:r});!1===e.error?(this.showMessage("Registration successful! Please login to continue.","success"),setTimeout((()=>{this.router.navigate("/login")}),2e3)):this.showMessage(e.message||"Registration failed","error")}catch(e){console.error("Registration error:",e),this.showMessage(e.message||"Registration failed","error")}finally{i.disabled=!1,s.style.display="inline",a.style.display="none"}}showMessage(e,t){const o=document.getElementById("register-message");o.className=`form-message ${t}`,o.textContent=e}}},763:(e,t,o)=>{o.d(t,{R:()=>n});class n{static setToken(e){localStorage.setItem("authToken",e)}static getToken(){return localStorage.getItem("authToken")}static removeToken(){localStorage.removeItem("authToken"),localStorage.removeItem("userInfo")}static setUserInfo(e){localStorage.setItem("userInfo",JSON.stringify(e))}static getUserInfo(){const e=localStorage.getItem("userInfo");return e?JSON.parse(e):null}static isAuthenticated(){return!!this.getToken()}static logout(){this.removeToken(),window.location.hash="/login"}}},789:(e,t,o)=>{o.d(t,{r:()=>r});var n=o(676);class r{constructor(e){this.router=e}render(){document.getElementById("page-container").innerHTML='\n            <div class="page">\n                <section class="auth-section">\n                    <div class="auth-container">\n                        <h1>Login to Story App</h1>\n                        <form id="login-form" class="form-container">\n                            <div class="form-group">\n                                <label for="login-email" class="form-label">Email *</label>\n                                <input type="email" \n                                       id="login-email" \n                                       name="email" \n                                       class="form-input" \n                                       required\n                                       placeholder="Enter your email">\n                                <div class="form-error" id="email-error"></div>\n                            </div>\n                            \n                            <div class="form-group">\n                                <label for="login-password" class="form-label">Password *</label>\n                                <input type="password" \n                                       id="login-password" \n                                       name="password" \n                                       class="form-input" \n                                       required\n                                       placeholder="Enter your password">\n                                <div class="form-error" id="password-error"></div>\n                            </div>\n                            \n                            <div class="form-actions">\n                                <button type="submit" class="btn btn-primary" id="login-btn">\n                                    <span class="btn-text">Login</span>\n                                    <span class="btn-loading" style="display: none;">\n                                        <span class="loading-spinner small"></span>\n                                        Logging in...\n                                    </span>\n                                </button>\n                            </div>\n                            \n                            <div id="login-message"></div>\n                        </form>\n                        \n                        <div class="auth-switch">\n                            <p>Don\'t have an account? <a href="#/register" class="link">Register here</a></p>\n                        </div>\n                    </div>\n                </section>\n            </div>\n        ',this.initializeForm()}initializeForm(){document.getElementById("login-form").addEventListener("submit",(e=>this.handleLogin(e)))}async handleLogin(e){e.preventDefault();const t=document.getElementById("login-email").value.trim(),o=document.getElementById("login-password").value;if(!t||!o)return void this.showMessage("Please fill in all fields","error");const r=document.getElementById("login-btn"),i=r.querySelector(".btn-text"),s=r.querySelector(".btn-loading");r.disabled=!0,i.style.display="none",s.style.display="inline-flex";try{const e=await n.U.login({email:t,password:o});!1===e.error&&e.loginResult?(this.showMessage("Login successful! Redirecting...","success"),setTimeout((()=>{this.router.navigate("/home"),window.app&&window.app.updateNavbar&&window.app.updateNavbar()}),1500)):this.showMessage(e.message||"Login failed","error")}catch(e){console.error("Login error:",e),this.showMessage(e.message||"Login failed","error")}finally{r.disabled=!1,i.style.display="inline",s.style.display="none"}}showMessage(e,t){const o=document.getElementById("login-message");o.className=`form-message ${t}`,o.textContent=e}}},836:(e,t,o)=>{o.d(t,{I:()=>n});class n{constructor(){this.routes={},this.currentRoute=null,this.init()}init(){window.addEventListener("hashchange",(()=>this.handleRoute())),window.addEventListener("load",(()=>this.handleRoute()))}addRoute(e,t){this.routes[e]=t}handleRoute(){const e=window.location.hash.slice(1)||"/home",t=this.routes[e]||this.routes["/home"];t&&"function"==typeof t&&(document.startViewTransition?document.startViewTransition((()=>{t()})):t())}navigate(e){window.location.hash=e}getCurrentRoute(){return window.location.hash.slice(1)||"/home"}}},867:(e,t,o)=>{o.d(t,{G:()=>r});var n=o(573);class r{constructor(){this.container=document.getElementById("page-container"),this.savedStories=[]}async render(){this.container.innerHTML='\n      <section class="saved-stories-section">\n        <h2>Your Saved Stories</h2>\n        <p>Stories saved for offline viewing.</p>\n        <div class="saved-stories-container" id="saved-stories-container">\n          <div class="loading-indicator">Loading saved stories...</div>\n        </div>\n      </section>\n    ',await this.loadSavedStories()}async loadSavedStories(){try{const e=document.getElementById("saved-stories-container");if(this.savedStories=await n.A.getAllStories(),0===this.savedStories.length)return void(e.innerHTML='\n          <div class="empty-state">\n            <p>You haven\'t saved any stories yet.</p>\n            <p>Stories you view will be automatically saved for offline viewing.</p>\n          </div>\n        ');this.savedStories.sort(((e,t)=>new Date(t.savedAt)-new Date(e.savedAt))),e.innerHTML=this.savedStories.map((e=>`\n          <div class="story-card" data-id="${e.id}">\n            <div class="story-image">\n              <img src="${e.photoUrl}" alt="${e.name}'s story" loading="lazy">\n            </div>\n            <div class="story-content">\n              <h3 class="story-title">${e.name}</h3>\n              <p class="story-description">${e.description}</p>\n              <div class="story-meta">\n                <span class="story-date">Saved: ${this.formatDate(e.savedAt)}</span>\n              </div>\n              <div class="story-actions">\n                <button class="btn btn-danger delete-story-btn" data-id="${e.id}">\n                  Delete from Saved Stories\n                </button>\n                ${e.isFavorite?"":`\n                <button class="btn btn-primary add-favorite-btn" data-id="${e.id}">\n                  Add to Favorites\n                </button>\n                `}\n              </div>\n            </div>\n          </div>\n        `)).join(""),this.addButtonListeners()}catch(e){console.error("Error loading saved stories:",e),document.getElementById("saved-stories-container").innerHTML=`\n        <div class="error-state">\n          <p>Failed to load your saved stories.</p>\n          <p>Error: ${e.message}</p>\n        </div>\n      `}}addButtonListeners(){document.querySelectorAll(".delete-story-btn").forEach((e=>{e.addEventListener("click",(async e=>{const t=e.target.dataset.id;try{await n.A.deleteStory(t),await this.loadSavedStories(),this.showNotification("Story deleted from saved stories")}catch(e){console.error("Error deleting story:",e),this.showNotification("Failed to delete story","error")}}))})),document.querySelectorAll(".add-favorite-btn").forEach((e=>{e.addEventListener("click",(async e=>{const t=e.target.dataset.id;try{const e=this.savedStories.find((e=>e.id===t));e&&(await n.A.addToFavorites(e),await this.loadSavedStories(),this.showNotification("Story added to favorites"))}catch(e){console.error("Error adding to favorites:",e),this.showNotification("Failed to add to favorites","error")}}))}))}showNotification(e,t="success"){const o=document.createElement("div");o.className=`notification ${t}`,o.textContent=e,document.body.appendChild(o),setTimeout((()=>{o.classList.add("fade-out"),setTimeout((()=>{document.body.removeChild(o)}),500)}),3e3)}formatDate(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}destroy(){document.querySelectorAll(".delete-story-btn").forEach((e=>{e.removeEventListener("click",(()=>{}))})),document.querySelectorAll(".add-favorite-btn").forEach((e=>{e.removeEventListener("click",(()=>{}))}))}}},871:(e,t,o)=>{o.d(t,{w:()=>c});var n=o(717),r=o(454),i=o(676),s=o(170),a=o(459),d=o(573);class l{constructor(e,t){this.view=e,this.router=t}async addStory(e){try{console.log("Submitting story...");const t=await i.U.addStory(e);if(!1===t.error){try{const t=e.get("description"),o={id:`story-${Date.now()}`,name:"My Story",description:t,createdAt:(new Date).toISOString(),savedAt:(new Date).toISOString()},n=e.get("photo");n&&n instanceof Blob&&(o.photoUrl=URL.createObjectURL(n));const r=e.get("lat"),i=e.get("lon");r&&i&&(o.lat=parseFloat(r),o.lon=parseFloat(i)),await d.A.addStory(o),console.log("Story saved to IndexedDB")}catch(e){console.error("Failed to save story to IndexedDB:",e)}try{const e=await a.A.checkPushSupport();e.supported&&"granted"===e.permission&&(await a.A.subscribeToPushNotifications(),console.log("Push notification subscription refreshed after adding story"))}catch(e){console.error("Error with push notification:",e)}this.view.showMessage("Story added successfully! Redirecting...","success"),setTimeout((()=>{this.router.navigate("/home")}),2e3)}else this.view.showMessage(t.message||"Failed to add story","error");return t}catch(e){console.error("Error adding story:",e);const t=e instanceof s.h?s.h.handle(e):e.message||"Failed to add story. Please try again.";throw this.view.showMessage(t,"error"),e}}validateForm(e,t,o){let n=!0;return e?e.length<10?(this.view.showError("description-error","Description must be at least 10 characters"),n=!1):e.length>1e3?(this.view.showError("description-error","Description must not exceed 1000 characters"),n=!1):this.view.clearError("description-error"):(this.view.showError("description-error","Description is required"),n=!1),t?t.size>5242880?(this.view.showError("photo-error","Photo size must be less than 5MB"),n=!1):this.view.clearError("photo-error"):(this.view.showError("photo-error","Please capture a photo"),n=!1),o?this.view.clearError("location-error"):(this.view.showError("location-error","Please select a location"),n=!1),n}}class c{constructor(e){this.router=e,this.presenter=new l(this,e),this.camera=null,this.map=null,this.selectedLocation=null,this.mapComponent=null,this.photoPreview=null,this.selectedPosition=null}render(){document.getElementById("page-container").innerHTML='\n      <div class="page">\n        <h2 tabindex="-1" id="add-story-heading">Add New Story</h2>\n        <section class="add-story-section">\n          <div id="notification-container" class="notification-container"></div>\n          <form id="add-story-form" class="form-container" novalidate>\n            <div class="form-group">\n              <label for="story-description" class="form-label">Description *</label>\n              <textarea id="story-description" \n                name="description" \n                class="form-textarea" \n                required\n                placeholder="Tell your story..."\n                maxlength="1000"></textarea>\n              <small class="form-help">Maximum 1000 characters</small>\n              <div class="form-error" id="description-error"></div>\n            </div>\n            \n            <div class="form-group">\n              <label class="form-label">Photo *</label>\n              <div id="camera-container"></div>\n              <div class="form-error" id="photo-error"></div>\n            </div>\n            \n            <div class="form-group">\n              <label class="form-label">Location *</label>\n              <p class="form-help">Click on the map to select your story location</p>\n              <div id="location-map" class="map-container"></div>\n              <input type="hidden" id="latitude" name="lat">\n              <input type="hidden" id="longitude" name="lon">\n              <p id="location-info" class="location-info">No location selected</p>\n              <div class="form-error" id="location-error"></div>\n            </div>\n            \n            <div class="form-group notification-opt-in">\n              <label>\n                <input type="checkbox" id="enable-notifications" checked>\n                Enable notifications for new stories\n              </label>\n            </div>\n            \n            <div class="form-actions">\n              <button type="submit" class="btn btn-primary" id="submit-btn">\n                <span class="btn-text">Add Story</span>\n                <span class="btn-loading" style="display: none;">\n                  <span class="loading-spinner small"></span>\n                  Adding...\n                </span>\n              </button>\n              <button type="button" class="btn btn-secondary" onclick="history.back()">Cancel</button>\n            </div>\n            \n            <div id="form-message"></div>\n          </form>\n        </section>\n      </div>\n    ',setTimeout((()=>{this.initializeComponents(),this.initializeForm();const e=document.getElementById("add-story-heading");e&&e.focus(),this.setupPushNotificationSubscription()}),100)}initializeComponents(){try{this.camera=new n.n("camera-container"),this.map=new r.i("location-map",{clickable:!0,showPopup:!0,onLocationSelect:(e,t)=>this.onLocationSelect(e,t)}),this.map.init()}catch(e){console.error("Error initializing components:",e),this.showMessage("Error initializing components. Please refresh the page.","error")}}onLocationSelect(e,t){this.selectedLocation={lat:e,lng:t},document.getElementById("latitude").value=e,document.getElementById("longitude").value=t,document.getElementById("location-info").textContent=`Selected: ${e.toFixed(6)}, ${t.toFixed(6)}`,this.clearError("location-error")}initializeForm(){document.getElementById("add-story-form").addEventListener("submit",(e=>this.handleSubmit(e)))}async handleSubmit(e){e.preventDefault();const t=document.getElementById("story-description").value.trim(),o=this.camera?.getCapturedPhoto();if(!this.presenter.validateForm(t,o,this.selectedLocation))return void this.showMessage("Please fill all required fields","error");const n=document.getElementById("submit-btn"),r=n.querySelector(".btn-text"),i=n.querySelector(".btn-loading");n.disabled=!0,r.style.display="none",i.style.display="inline-flex";try{const e=this.prepareFormData();await this.presenter.addStory(e)}catch(e){console.error("Error submitting story:",e)}finally{n.disabled=!1,r.style.display="inline",i.style.display="none"}}prepareFormData(){const e=new FormData,t=document.getElementById("story-description").value.trim(),o=this.camera.getCapturedPhoto(),{lat:n,lng:r}=this.selectedLocation;if(!(t&&o&&n&&r))throw new Error("All fields are required");if(!(o instanceof Blob))throw new Error("Invalid photo format");if(isNaN(n)||isNaN(r))throw new Error("Invalid location coordinates");return e.append("description",t),e.append("photo",o,`story-${Date.now()}.jpg`),e.append("lat",parseFloat(n).toString()),e.append("lon",parseFloat(r).toString()),e}showMessage(e,t){const o=document.getElementById("form-message");o.className=`form-message ${t}`,o.textContent=e,o.scrollIntoView({behavior:"smooth",block:"nearest"})}showError(e,t){const o=document.getElementById(e);o&&(o.textContent=t,o.style.display="block")}clearError(e){const t=document.getElementById(e);t&&(t.textContent="",t.style.display="none")}destroy(){try{this.camera&&this.camera.destroy(),this.map&&this.map.destroy()}catch(e){console.error("Error destroying view:",e)}}initMap(){setTimeout((()=>{try{this.mapComponent=new r.i("location-map",{clickable:!0,showPopup:!1,zoom:5}),this.mapComponent.init(),this.mapComponent.onMapClick((e=>{const{lat:t,lng:o}=e.latlng;this.selectedPosition={lat:t,lng:o},this.updateLocationInfo(),this.mapComponent.addMarker(t,o)}))}catch(e){console.error("Error initializing map:",e),document.getElementById("location-map").innerHTML=`\n          <div class="map-error">\n            <p>Unable to load map</p>\n            <small>Error: ${e.message}</small>\n          </div>\n        `}}),100)}updateLocationInfo(){const e=document.getElementById("location-info");if(this.selectedPosition){const{lat:t,lng:o}=this.selectedPosition;e.innerHTML=`\n        <p>Selected location: ${t.toFixed(6)}, ${o.toFixed(6)}</p>\n      `}else e.innerHTML="<p>No location selected</p>"}setupPhotoPreview(){const e=document.getElementById("story-description"),t=document.getElementById("camera-container");e.addEventListener("change",(e=>{const o=e.target.files[0];if(!o)return t.innerHTML="<p>No photo selected</p>",void(this.photoPreview=null);if(!o.type.startsWith("image/"))return t.innerHTML='<p class="error">Please select an image file</p>',void(this.photoPreview=null);const n=new FileReader;n.onload=e=>{this.photoPreview=e.target.result,t.innerHTML=`\n          <img src="${this.photoPreview}" alt="Preview" class="photo-preview" />\n        `},n.readAsDataURL(o)}))}async setupPushNotificationSubscription(){try{const e=await a.A.checkPushSupport(),t=document.getElementById("notification-container");if(!e.supported)return void(t.innerHTML='\n          <div class="notification-prompt warning">\n            <p>Your browser doesn\'t support push notifications.</p>\n          </div>\n        ');"denied"===e.permission?t.innerHTML='\n          <div class="notification-prompt warning">\n            <p>Push notifications are blocked. Please enable them in your browser settings.</p>\n          </div>\n        ':"default"===e.permission?(t.innerHTML='\n          <div class="notification-prompt">\n            <p>Get notified when new stories are added!</p>\n            <button class="btn btn-primary" id="enable-notifications-btn">Enable Notifications</button>\n          </div>\n        ',document.getElementById("enable-notifications-btn").addEventListener("click",(async()=>{try{await a.A.subscribeToPushNotifications(),t.innerHTML='\n              <div class="notification-prompt success">\n                <p>Notifications enabled successfully!</p>\n              </div>\n            ',setTimeout((()=>{t.innerHTML=""}),3e3)}catch(e){console.error("Failed to enable notifications:",e),t.innerHTML=`\n              <div class="notification-prompt error">\n                <p>Failed to enable notifications: ${e.message}</p>\n              </div>\n            `}}))):console.log("Push notifications already enabled")}catch(e){console.error("Error checking push notification support:",e)}}}}}]);